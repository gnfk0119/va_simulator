# VA Simulator 작동 알고리즘 문서 (Algorithm Specification)

본 문서는 `va_simulator`가 어떻게 스마트홈 환경과 가구 데이터를 생성하고, 4-Cell Matrix 기반의 시뮬레이션을 수행하는지 그 핵심 작동 알고리즘을 상세히 설명하기 위해 작성되었습니다. 코드의 의도와 동작을 정확히 파악하기 위한 가이드입니다.

---

## 1. 사전 데이터 생성 로직 (Phase 1: Generate)

시뮬레이션 구동 전, 가상 가족(Family)과 그들이 거주할 공간(Environment)을 생성합니다. (현재 `num_profiles: 1` 설정 시 1가구와 1공간이 1:1로 매핑됩니다.)

### 1-1. 공간(Environment) 할당
1. **타입 선택**: `data/templates/home.json`에 정의된 4가지 아파트 평면도 타입(A, B, C, D) 중 **오직 1개**를 무작위로 선택합니다. ("4개 중 하나만 할당" 요구사항)
2. **구조 부여**: 선택된 1개 타입의 방 이름들과 속성을 추출하여 LLM에게 전달합니다. 
3. **기기 셋업**: LLM은 해당 타입의 방 구조에 맞게 거실(에어컨, TV 등), 주방(냉장고 등) 및 각 침실에 스마트 기기 초기 상태(JSON)를 생성합니다. 이때 모든 기기는 `is_observable` (관찰 가능) 속성을 가집니다.

### 1-2. 가구(Family) 및 가구원 생성
1. **Bio 생성**: 프롬프트 시드(Prompt) 또는 랜덤(Random) 조건에 맞춰 가족 구성원을 생성합니다. 이때 **"다른 가족 구성원과의 관계와 상호작용 패턴"**을 필수적으로 포함하도록 강제하여 생생한 `bio`를 작성합니다.
2. **스케줄 샘플링**: 통계청 통계 데이터(`2024_시간대_분석.xlsx`)의 확률 분포를 기반으로, 각 인물의 성별/나이/경제상태에 맞는 시간대별(15분 단위) 활동을 샘플링합니다.

---

## 2. 시뮬레이션 엔진 로직 (Phase 2 & 3: Simulate + Evaluate)

가구원들의 15분 단위 행동 흐름을 추적하고, 발화 명령을 생성하며 그에 따른 스마트홈 기기 상태 변화를 4가지 Cell로 나누어 시뮬레이션합니다. 

### 2-1. 행동 추출 및 장소(Location) 파악 (Action Context)
각 시간 스텝마다 가족 구성원의 구체적 행동 묘사를 생성합니다.
* **Shared Memory (공유 기억)**: 집 내부의 같은 시간대에 일어나는 다른 가족 구성원의 행동(기억)을 LLM에 컨텍스트로 제공합니다.
* **핵심 추출 변수**:
  1. `quarterly_activity`: 15분 내 핵심 활동 (요약)
  2. **`location` & `is_at_home`**: 현재 인물이 **집 내부의 어느 구체적인 방**(예: 침실1, 거실, 주방)에 있는지, 혹은 **집 밖에 있는지** 명확히 구분하여 생성합니다.
  3. `concrete_action`: 최소 3문장 이상의 상세 행동 묘사.
  4. **`wc_command`**: 현재 상황(Context)에서 기기를 제어하기 위해 VA에게 내릴 자연스러운 발화 (예: *"미세먼지 심한데 거실 공기청정기 좀 켜줘"*).

### 2-2. 명령어 필터링 (WC -> WOC 변환)
기존의 Latent Command 방식을 폐기하고, 사용자 맥락이 담긴 자연스러운 발화(`wc_command`)를 먼저 생성한 뒤 이를 기반으로 WOC 발화를 추출합니다.
* **명령 1 (WC, With Context)**: 앞서 생성된 자연스러운 발화.
* **명령 2 (WOC, Without Context)**: LLM을 통해 `wc_command`에서 모든 구체적 맥락과 상황 설명을 걷어내고, 오직 "기기 제어"라는 알맹이만 남긴 건조하고 직접적인 명령어로 변환합니다. (예: *"거실 공기청정기 켜"*)

### 2-3. 4-Cell 매트릭스 실행 (고립 원칙 준수)
생성된 2가지 명령(WC, WOC)을 각각 2가지 VA 에이전트(VA_C, VA_R)에 전달해 총 4개의 교차 조건을 실험합니다. **시간에 따른 영구적 기기 상태(Persist) 변화는 4개의 공간(Cell) 중 오직 `[WC x VAC]` (기준 셀)의 결과만 전역 환경 모델에 업데이트 적용**되며, 나머지 3개 Cell은 상태가 복사(Deep Copy)된 임시 환경에서 독립적으로 실행된 뒤 결과를 버립니다.

* **Cell 1 (`[WC x VAC]`)**: (맥락 발화) x (LLM Baseline) -> **전역 환경 상태 영구 저장 (Persist)**
* **Cell 2 (`[WC x VAR]`)**: (맥락 발화) x (Classifier Rule-based) -> 복사된 환경에서 실행 후 **Log만 기록**
* **Cell 3 (`[WOC x VAC]`)**: (건조한 발화) x (LLM Baseline) -> 복사된 환경에서 실행 후 **Log만 기록**
* **Cell 4 (`[WOC x VAR]`)**: (건조한 발화) x (Classifier Rule-based) -> 복사된 환경에서 실행 후 **Log만 기록**

### 2-4. 모의 평가 및 관찰자 평가
* **Self Evaluation**: 각 4개의 상호작용 후, VA의 응답과 기기 상태 변화를 바탕으로 가상 유저(LLM)가 1~5점 척도와 평가 이유(self_reason)를 스스로 남깁니다.
* **Observer Evaluation**: (Evaluate 모드) 제3자인 관찰자(LLM) 입장에서 전체 로그를 읽어들이며 다시 한 번 객관적인 평가 점수를 냅니다.

---

## 3. 출력물 및 최종 매핑 (Phase 4: Export & Match)

시뮬레이션 종료 후, 수집된 로그 데이터를 바탕으로 최종 엑셀을 추출합니다. 이 때 `exporter.py`를 통해 파싱합니다.

1. **`1_family_info.xlsx`**: 각 가구원의 Bio와 기본 설정값
2. **`2_memory_history.xlsx`**: 기존의 단순 나열 방식에서 벗어나, **각 인물별(Member ID별 정렬)** 및 시간별로 집안 곳곳에서 남긴 모든 메모리와 행동을 그룹화하여 보여줍니다.
3. **`3_interaction_history.xlsx`**: 앞서 실행된 4개의 셀 각각의 명령어, 반응, Self/Observer Rating, Gap 점수를 포함한 전체 결과 매트릭스.
> 이후 `.venv/bin/python scripts/match_assign.py`가 엑셀을 수정하여 평가(Gap) 기반의 BG/SG 분류(Classification)를 수행하고 파일을 최종 완성합니다.
